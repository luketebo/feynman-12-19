<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>è´¹æ›¼å® ç‰© - å­¦ä¹ ä¼´ä¾£</title>
        <style>
            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                margin: 0;
                background-color: #e5ddd5;
                display: flex;
                height: 100vh;
            }
            .sidebar {
                width: 250px;
                background: #fff;
                border-right: 1px solid #ddd;
                padding: 20px;
                display: flex;
                flex-direction: column;
            }
            .chat-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                background: #efe7dd;
            }
            .header {
                background: #075e54;
                color: white;
                padding: 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .messages {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            .message {
                max-width: 70%;
                padding: 10px;
                border-radius: 8px;
                position: relative;
                line-height: 1.4;
            }
            .user {
                align-self: flex-end;
                background: #dcf8c6;
            }
            .assistant {
                align-self: flex-start;
                background: white;
            }
            .assistant.typing::after {
                content: "...";
                animation: blink 1s infinite;
            }
            @keyframes blink {
                0% {
                    opacity: 0;
                }
                50% {
                    opacity: 1;
                }
                100% {
                    opacity: 0;
                }
            }
            .input-area {
                padding: 20px;
                background: #f0f0f0;
                display: flex;
                gap: 10px;
            }
            input {
                flex: 1;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 20px;
                outline: none;
            }
            button {
                padding: 10px 20px;
                background: #075e54;
                color: white;
                border: none;
                border-radius: 20px;
                cursor: pointer;
            }
            .status-item {
                margin-bottom: 15px;
            }
            .status-label {
                font-weight: bold;
                color: #666;
                font-size: 0.9rem;
            }
            .status-value {
                font-size: 1.2rem;
                color: #075e54;
            }
            .pet-avatar {
                width: 100px;
                height: 100px;
                background: #eee;
                border-radius: 50%;
                margin: 0 auto 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 3rem;
            }
            .mode-switch {
                margin-top: 20px;
                padding: 10px;
                background: #f9f9f9;
                border-radius: 8px;
                border: 1px solid #ddd;
            }
            .mode-switch label {
                font-size: 0.8rem;
                color: #666;
                display: block;
                margin-bottom: 5px;
            }
            .mode-switch select {
                width: 100%;
                padding: 5px;
                border-radius: 4px;
                border: 1px solid #ccc;
            }
            .icon {
                width: 40px;
                height: 100%;
            }
            /* 1. ç¡®ä¿ chat-container æ˜¯å®šä½åŸºå‡† */
            .chat-container {
                position: relative; /* å…³é”®å±æ€§ï¼Œè®©ç»å¯¹å®šä½çš„è’™ç‰ˆé™åˆ¶åœ¨è¿™ä¸ªå®¹å™¨å†… */
            }

            /* 1. è’™ç‰ˆå®¹å™¨å¸ƒå±€ä¼˜åŒ– */
            .call-overlay {
                /* ä¹‹å‰çš„æ ·å¼ä¿æŒä¸å˜ */
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(
                    255,
                    255,
                    255,
                    0.85
                ); /* èƒŒæ™¯ç¨å¾®è°ƒç™½ä¸€ç‚¹ */
                backdrop-filter: blur(8px);
                z-index: 1000;

                /* å…³é”®å¸ƒå±€è®¾ç½® */
                display: flex;
                flex-direction: column;
                justify-content: space-between; /* å†…å®¹ä¸¤ç«¯å¯¹é½ï¼šä¸­é—´å†…å®¹ å’Œ åº•éƒ¨æŒ‰é’® */
                align-items: center;
                padding-bottom: 50px; /* è·ç¦»åº•éƒ¨çš„ç•™ç™½ */
                box-sizing: border-box; /* ç¡®ä¿ padding ä¸ä¼šæ’‘å¤§å®¹å™¨ */
            }

            /* 2. ä¸­é—´çš„å†…å®¹åŒºåŸŸ (å¤´åƒ/çŠ¶æ€æ–‡å­—/åŠ è½½åœˆ) */
            .call-center-content {
                flex: 1; /* å æ®å‰©ä½™ç©ºé—´ï¼Œç¡®ä¿å®ƒåœ¨è§†è§‰ä¸­å¿ƒ */
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                width: 100%;
            }

            /* 3. åº•éƒ¨æ§åˆ¶æ  */
            .call-controls {
                display: flex;
                gap: 40px; /* æŒ‰é’®é—´è·åŠ å¤§ä¸€ç‚¹ */

                /* åˆå§‹çŠ¶æ€ï¼šéšè— + ä¸‹æ²‰ */
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.5s ease; /* 0.5ç§’çš„è¿‡æ¸¡åŠ¨ç”» */
            }

            /* 4. å½“æ·»åŠ è¿™ä¸ªç±»æ—¶ï¼ŒæŒ‰é’®æ˜¾ç¤ºå¹¶ä¸Šæµ® */
            .call-controls.visible {
                opacity: 1;
                transform: translateY(0);
            }

            /* ä¹‹å‰çš„åŠ è½½åœˆæ ·å¼ä¿æŒä¸å˜ */
            .loader {
                border: 6px solid #f3f3f3;
                border-top: 6px solid #075e54;
                border-radius: 50%;
                width: 80px; /* ç¨å¾®å¤§ä¸€ç‚¹ */
                height: 80px;
                animation: spin 1s linear infinite;
                margin-bottom: 30px;
            }
            /* 2. å®šä¹‰åŠ¨ç”»çš„å…³é”®å¸§ (è¿™ä¸€æ®µç»å¸¸è¢«é—æ¼ï¼) */
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            .thinking-text {
                font-size: 1.2rem;
                color: #333;
                font-weight: 500;
            }
            /* --- åº•éƒ¨æŒ‰é’®ä¿®æ­£ç‰ˆ --- */

            .control-btn {
                width: 60px;
                height: 60px;
                border-radius: 50%;

                /* 1. å¼ºåˆ¶è¦†ç›–å…¨å±€çš„ç»¿è‰²èƒŒæ™¯ */
                background: #e0e0e0 !important; /* é»˜è®¤æµ…ç°è‰² */

                /* 2. å»æ‰å…¨å±€æŒ‰é’®çš„å†…è¾¹è·ï¼Œç¡®ä¿æ˜¯æ­£åœ†å½¢ */
                padding: 0 !important;

                /* 3. å»æ‰è¾¹æ¡† */
                border: none !important;

                /* å…¶ä»–å¸ƒå±€æ ·å¼ */
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
                transition: transform 0.2s, background 0.2s;
            }

            /* æŒ‰ä¸‹æ•ˆæœ */
            .control-btn:active {
                transform: scale(0.95);
            }

            /* æŒ‚æ–­æŒ‰é’® - çº¢è‰² */
            .btn-hangup {
                /* å¼ºåˆ¶çº¢è‰²èƒŒæ™¯ */
                background: #ff3b30 !important;
            }

            /* æŒ‚æ–­æŒ‰é’®çš„å›¾æ ‡å˜æˆç™½è‰² */
            .btn-hangup svg {
                fill: white;
            }

            /* éº¦å…‹é£å›¾æ ‡å¤§å° */
            .control-btn svg {
                width: 28px;
                height: 28px;
                fill: #333;
            }
        </style>
    </head>
    <body>
        <div class="sidebar">
            <div class="pet-avatar">
                
                <img
                id="call-avatar"
                src="{{ url_for('static', filename=avatar_filename) }}"
                alt="å¤´åƒ"
                style="
                    width: 100px; /* å®½åº¦ï¼šæ§åˆ¶å¤§å° (åŸæ–‡å­—æ˜¯80pxï¼Œå›¾ç‰‡100pxè§†è§‰ä¸Šå·®ä¸å¤š) */
                    height: 100px; /* é«˜åº¦ï¼šä¿æŒæ­£æ–¹å½¢ */
                    border-radius: 50%; /* å˜æˆåœ†å½¢ */
                    object-fit: cover; /* é˜²æ­¢å›¾ç‰‡å˜å½¢ (è£å‰ªå¡«å……) */
                    margin-bottom: 20px; /* åº•éƒ¨ç•™ç™½ */
                    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* åŠ ä¸€ç‚¹é˜´å½±æ›´ç«‹ä½“ */
                    border: 3px solid white; /* å¯é€‰ï¼šåŠ ä¸€ä¸ªç™½è¾¹æ¡† */
                "
            />
            </div>
            <h3 style="text-align: center">{{ pet.name }}</h3>
            <div class="status-item">
                <div class="status-label">ç­‰çº§</div>
                <div id="pet-level" class="status-value">
                    Lv. {{ pet.level }}
                </div>
            </div>
            <div class="status-item">
                <div class="status-label">ç»éªŒ</div>
                <div id="pet-exp" class="status-value">
                    {{ pet.experience }} / {{ pet.level * 100 }}
                </div>
            </div>
            <div class="status-item">
                <div class="status-label">æˆ‘çš„é‡‘å¸</div>
                <div id="user-coins" class="status-value">
                    ğŸ’° {{ pet.owner.coins }}
                </div>
            </div>

            <div class="status-item">
                <div class="status-label">
                    å·²æŒæ¡çŸ¥è¯† (<span id="knowledge-count"
                        >{{ pet.knowledge.split('\n')|length if pet.knowledge
                        else 0 }}</span
                    >)
                </div>
                <div
                    id="pet-knowledge"
                    style="
                        font-size: 0.8rem;
                        color: #444;
                        max-height: 150px;
                        overflow-y: auto;
                        white-space: pre-wrap;
                    "
                >
                    {{ pet.knowledge or 'æš‚æ— çŸ¥è¯†' }}
                </div>
            </div>

            <div style="margin-top: 20px">
                <a
                    href="{{ url_for('pet.list_pets') }}"
                    style="
                        display: block;
                        margin-bottom: 10px;
                        color: #075e54;
                        text-decoration: none;
                        font-weight: bold;
                    "
                    >â† è¿”å›å® ç‰©åˆ—è¡¨</a
                >
                <a
                    href="{{ url_for('shop.index') }}"
                    style="
                        display: block;
                        margin-bottom: 10px;
                        color: #075e54;
                        text-decoration: none;
                        font-weight: bold;
                    "
                    >ğŸ›’ å‰å¾€å•†åŸ</a
                >
            </div>
        </div>

        <div class="chat-container">
            <div class="header">
                <span>æ­£åœ¨æ•™å¯¼ {{ pet.name }} - {{ chat_session.title }}</span>
                <a
                    href="{{ url_for('auth.logout') }}"
                    style="
                        color: white;
                        text-decoration: none;
                        font-size: 0.8rem;
                        border: 1px solid rgba(255, 255, 255, 0.5);
                        padding: 4px 12px;
                        border-radius: 15px;
                        transition: all 0.3s;
                    "
                    >é€€å‡ºç™»å½•</a
                >
            </div>
            <div class="messages" id="message-box">
                {% for msg in messages %}
                <div
                    class="message {{ 'user' if msg.role == 'user' else 'assistant' }}"
                >
                    {{ msg.content }}
                </div>
                {% endfor %}
            </div>
            <div class="input-area">
                <input
                    type="text"
                    id="user-input"
                    placeholder="å‘{{ pet.name }}è§£é‡Šä¸€ä¸ªæ¦‚å¿µ..."
                    onkeypress="if(event.keyCode==13) sendMessage()"
                />
                <button onclick="sendMessage()">å‘é€</button>
                <div onclick="callPhone()" style="cursor: pointer">
                    <svg
                        t="1766572058259"
                        class="icon"
                        viewBox="0 0 1024 1024"
                        version="1.1"
                        xmlns="http://www.w3.org/2000/svg"
                        p-id="1723"
                        width="200"
                        height="200"
                    >
                        <path
                            d="M217.856 94.677333c-36.608 14.762667-60.928 38.485333-96.597333 83.2-88.618667 111.232-9.386667 332.8 194.730666 535.210667l10.581334 10.368c192 184.576 434.986667 264.533333 527.701333 184.064l3.029333-2.816-1.450666 1.194667a249.301333 249.301333 0 0 0 64.042666-77.994667c33.152-64 24.149333-130.858667-41.173333-182.954667-94.037333-75.008-157.184-77.568-219.434667-20.48l-6.997333 6.570667-18.005333 17.834667c-7.808-1.621333-19.882667-7.338667-34.730667-16.896-29.610667-19.114667-66.517333-50.901333-108.586667-92.586667-41.941333-41.642667-74.069333-78.208-93.312-107.605333l-3.882666-6.101334a120.448 120.448 0 0 1-12.245334-24.832l-0.938666-3.413333 18.133333-17.92 6.613333-6.954667c57.472-61.738667 54.912-124.373333-20.650666-217.642666-51.328-63.36-109.653333-83.328-166.826667-60.245334z m99.925333 113.493334l11.221334 14.08c37.546667 48.682667 37.888 64.853333 16.384 89.258666l-8.32 8.874667-21.12 20.821333c-45.482667 45.056-25.258667 102.314667 41.856 181.205334l14.08 16.085333 15.232 16.682667 8.106666 8.533333 16.981334 17.621333 18.176 18.261334 9.258666 9.130666 18.090667 17.450667 17.408 16.298667c5.717333 5.205333 11.306667 10.24 16.810667 15.104l16.213333 13.909333c79.616 66.56 137.216 86.570667 182.698667 41.685333l21.034666-20.992 5.546667-5.248c24.277333-22.186667 39.296-25.301333 80.725333 3.968l12.586667 9.258667 14.250667 11.093333c31.232 24.917333 34.261333 47.573333 18.602666 77.781334a165.845333 165.845333 0 0 1-26.88 36.608l-7.253333 7.338666-5.546667 5.12-5.333333 4.650667c-14.421333 14.293333-69.888 15.658667-141.184-7.722667-90.709333-29.781333-189.994667-92.074667-280.746667-182.101333-177.109333-175.658667-241.408-355.413333-188.16-422.272 26.453333-33.194667 43.648-49.92 61.653334-57.173333 19.285333-7.808 38.570667-1.194667 67.626666 34.688z"
                            fill="#000000"
                            p-id="1724"
                        ></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- å¼•å…¥å¤–éƒ¨ JS æ–‡ä»¶ -->
        <script>
            // å®šä¹‰å…¨å±€é…ç½®å¯¹è±¡
            window.FLASK_CONFIG = {
                sessionId: {{ chat_session.id | tojson }},
                avatarUrl: "{{ url_for('static', filename=avatar_filename) }}", 
                chatStreamUrl: "{{ url_for('chat.chat_stream') }}"
            };                                                                                  
        </script>
        <script src="{{ url_for('static', filename='js/index.js') }}"></script>
    </body>
</html>
